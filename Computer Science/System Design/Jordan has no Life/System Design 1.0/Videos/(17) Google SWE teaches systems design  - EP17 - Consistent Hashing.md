---
Source:
  - https://www.youtube.com/watch?v=kiCbLOPmBh4
---
- ![[Screenshot 2024-10-02 at 12.56.15 AM.png]]
	- Intro
		- hey guys today we're back with another video about [[consistent hashing]]. um sorry for lying more than Bill Clinton about Monica Lewinsky in terms of me keeping saying that uh i'm gonna have Cassandra next but i'm afraid you guys are gonna have to wait two more videos longer to be introduced to my lovely lady Cassandra because uh first i gotta talk about consistent hashing and then i gotta talk about [[gossip protocols]] which are probably the last two pieces of the puzzle that are kind of prerequisites to understanding how Cassandra works. i don't really think it would be very fair of me if i was just like oh yeah so you know Cassandra does sharding using consistent hashing and then never bring it up in my channel because that's like exactly why i started this in the first place. It pisses me off that other channels do that so i'm going to cover this, it's a really short video and let's get through it and then get to the next one and then do Cassandra
	- Consistent Hashing Background
		- Description
			- In situations where we are trying to uniformly and randomly distribute load over nodes in a cluster, consistent hashing is away of doing so while also minimizing the amount of reshuffling previously hashed items when adding or removing nodes from the cluster.
			- Useful in:
				- Sharding
					- Minimal rebalancing of partitions leads to reduced stress of the network
				- Load balancing
					- Having the same requests to the same servers can allow for better cache performance
		- all right so consistent hashing what is it. Um in situations where you have to balance some sort of load between multiple nodes in a cluster and in addition to balancing that load, want to generally keep it such that the majority of the items that have already been sent to given nodes in the cluster stay at those nodes when new nodes are added or removed from the cluster, consistent hashing is the algorithm for you. So i'm going to go ahead and explain that later in this video but what are the two cases where we see this being useful. Well for starters we've got sharding. So for example anytime you're partitioning a data set, we want to make it such that you're not rebalancing a ton of the keys every single time you're adding or removing a node because that would lead to network congestion and then another situation we see this is something like a load balancer where a load balancer is directing traffic from clients to specific application servers and then generally speaking we want the same requests or similar requests to be going to the same servers simply so that we can cache certain previous api calls or database calls and that way just have better cache performance in general, more hits as opposed to misses 
	- Consistent Hashing Overview
		- Description
			- Pick any good hash function, and imagine its range
				- For the purposes of this video, let's imagine the hash function only returns outputs from 0-999
				- Visualize the range as if it was a ring
		- okay, so let's do an overview of consistent hashing. So for starters we're going to choose ourselves a hash function and a hash function basically takes any input and gives us an output for uh for some given range and the entire point of a hash function is basically just a one-way function from the output you can't really get back the input but that's kind of irrelevant here. So for the purposes of this video, let's imagine the hash function is only going to return the range 0 to 999 and then i'm going to put all those outputs on a ring. So after 999 you go right back to zero. So as you can see we have the ring below in this image. 
	- Consistent Hashing Overview
		- Description
			- To add nodes to a cluster, we add it to a random place in the ring (removing is the exact opposite)
				- In reality, we actually tend to add it to a few places in the ring
				- This helps us to make sure that new nodes are taking load relatively evenly from other nodes, as opposed to just one.
		- So let's imagine we want to add some nodes to a cluster because we want to be able to load balance between them or use consistent hashing to you know balance resources between all of these nodes. So in order to add nodes to this cluster, all we're going to do is perhaps use a second hash function or use even the original with something like the node ID or just even use a randomizer and then place it on the ring and then for removing we would go ahead and remove it from the ring. In reality though typically we don't just add one circle per node to the ring but we add many circles. The reason we do this is so that um if you were to just add one circle over the ring, that one circle might be in like a very unique portion of the ring and you know have no other nodes close to it and as a result it would take up a significant amount of the load and become a hot spot. So it's better to have multiple of these like virtual nodes which are just you know copies of the circle that we place around the ring and that helps us to more evenly distribute the load per node. Okay so uh now as you can see um imagine i have nodes one two and three and i'm gonna say okay for each node we're gonna put three copies of that node all over the ring and now we have all these nodes distributed hopefully relatively evenly throughout the ring.
	- Consistent Hashing Overview
		- Description
			- To determine where to place a given item
				- First take the hash of it
				- Then move around the ring clockwise until reaching one of the node circles, and send it to that node
		- So what are we gonna do say we're using this for sharding and i have the key Jordan and we want to determine where to place that key in value pair. First all i'm going to do is take the hash of the key. So in this case, I'm saying the hash of Jordan is 261. So as you can see on the ring, 261 is a little bit after that 250 marker and then all we're going to do is move clockwise around the ring until reaching one of the node circles and send it to that node. So pretty simple moving clockwise we first encounter node three. We're just going to go ahead and say now that the key Jordan is going to reside on node three, so as you can see this is like a pretty relatively constant time operation in terms of figuring out where each key is going to be placed and in addition to that, it should, assuming we have the right number of say like virtual nodes or just you know replicated circles per node here, it'll make sure that generally speaking the load balance is relatively even per node. Okay simple enough. And then obviously if i were to remove a node since you're removing all of those uh you know virtual copies of it, then in theory even the rebalancing on a removal should be relatively even too.
- ![[Screenshot 2024-10-02 at 12.59.03 AM.png]]
	- Consistent Hashing Summary
		- Description
			- Solid algorithm for distributing load evenly and trying to make sure that even on new membership or exits from the cluster, the majority of the items stay in the same place while still being evenly distributed.
			- Used in various load balances, and partitioning methods (we see this in Cassandra which is why I'm talking about it now.)
		- okay so like i said super quick video but the summary of consistent hashing is it's a good algorithm for distributing load evenly amongst nodes in a cluster and making sure that even on new membership or exits from that cluster, that the majority of the items are staying in the same place and only a few of them are going to be rerouted to other nodes. In terms of it being used in load balancers, this is a very popular algorithm and i also discussed it a bit in terms of partitioning and it's especially prevalent in Cassandra which i'll be covering in a couple of videos which is why i'm talking about it now. So yeah like i said this one's pretty simple and it should make a decent amount of sense but consistent hashing is just a really good way to make sure that you can distribute things not just evenly but also in a way that they stay to relatively the same spot even as the size and members of the cluster change. okay have a good one guys